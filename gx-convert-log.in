#!%PERL% -w

# $Id: gx-convert-log.in,v 1.2 2004-11-03 18:27:10-08 kst Exp $
# $Source: /home/kst/gx-map-redacted/gx-convert-log.in,v $

use strict;

########################################################################
# @Copyright@
#
# Copyright (c) 2004 The Regents of the University of California. All
# rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met:
#
# 1. Redistributions of source code must retain the above copyright
# notice, this list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright
# notice, this list of conditions and the following disclaimer in the
# documentation and/or other materials provided with the distribution.
#
# 3. All advertising materials mentioning features or use of this
# software must display the following acknowledgement: This product
# includes software developed by the Grid and Cluster Computing Group
# at the San Diego Supercomputer Center and its contributors.
#
# 4. Neither the name of the Center nor the names of its contributors
# may be used to endorse or promote products derived from this software
# without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS''
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
# THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS
# BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
# BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
# OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
# IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# @Copyright@
########################################################################

########################################################################
# Developed by Keith Thompson <kst@sdsc.edu>
########################################################################

use File::Basename ();
use Getopt::Long ();

sub Usage(@);

$| = 1;

my $Program_Name = File::Basename::basename $0;

# 
# Make warnings fatal.
# 
$SIG{__WARN__} = sub { die @_ };

my $Install_Dir;
BEGIN {
    $Install_Dir = '%INSTALL_DIR%';
    unshift @INC, "$Install_Dir/lib";
}
use Gridmap_Utils ();

my $now = time;

my $Rev = '$Revision: 1.2 $';
$Rev =~ s/^\\s*//;
$Rev =~ s/\s*\$$//;

Usage if scalar @ARGV != 1;
Usage "Can't read file $ARGV[0]\n" if not -r $ARGV[0];

my @refs = Gridmap_Utils::Read_Records '-multiple', $ARGV[0];

my $timestamp = Gridmap_Utils::Time_Image $now;
#
# The result of Time_Image starts with a raw timestamp.
# We don't want that in the log.
#
$timestamp =~ s/^\d+ //;

print '# $', 'Id:$', "\n";
print '# $', 'Source:$', "\n";
print "# Converted $timestamp by $Program_Name revision $Rev\n";
print "# Converting ", scalar @refs, " records\n";
print "\n";

foreach my $ref (@refs) {
    next if defined $ref->{SOURCE};
    my $owner_is_admin =
        ( defined $ref->{OWNER_NAME} and
          Gridmap_Utils::Is_Globus_Admin $ref->{OWNER_NAME} );

    my $comment = (defined $ref->{comment} ? $ref->{comment} : '');

    if (not $owner_is_admin) {
        $ref->{SOURCE} = 'user';
    }
    elsif ($comment =~ /^cacl certificate/) {
        $ref->{SOURCE} = 'NPACI-CA';
    }
    elsif ($comment =~ /^NPACI CA certificate/) {
        $ref->{SOURCE} = 'NPACI-CA';
    }
    elsif ($comment =~ /^SDSC CA certificate/) {
        $ref->{SOURCE} = 'SDSC-CA';
    }
    else {
        $ref->{SOURCE} = 'administrator';
    }
}

Gridmap_Utils::Write_Records '-multiple', '-', @refs;

print "# $Program_Name done.\n\n";

########################################################################

sub Usage(@) {
    print @_ if @_;
    print <<"EOF";
Usage: $Program_Name logfile
Reads a gx-map 0.3 requests.log file and writes on stdout an equivalent
file for use with gx-map release 0.4.
EOF
    exit 1;
} # Usage
