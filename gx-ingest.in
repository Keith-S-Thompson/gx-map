#!/usr/local/bin/perl5.6.0 -w

# $Id: gx-ingest.in,v 1.1 2003-11-16 21:46:03-08 kst Exp $
# $Source: /home/kst/gx-map-redacted/gx-ingest.in,v $

#
# gx-ingest
#
# Reads an existing grid-mapfile from stdin or a file specified on the
# command line.
#
# Writes on stdout a /bin/sh script that invokes gx-map for each
# entry in the input grid-mapfile.
#

use strict;

use File::Basename ();

my $Program_Name = File::Basename::basename $0;

my $gxmap_command = undef;
DIR:
foreach my $dir (split /:/, $ENV{PATH}) {
    if (-x "$dir/gx-map") {
        $gxmap_command = "$dir/gx-map";
        last DIR;
    }
}

my $definition;
if (defined $gxmap_command) {
    $definition = "gxmap=$gxmap_command  # Customize this if necessary";
}
else {
    $definition = 'gxmap=/path/to/gx-map  # Customize this';
}

print <<"EOF";
#!/bin/sh

#
# This script was generated by $Program_Name.
# Please check it carefully before running it.
#

$definition

EOF

while (<>) {
    chomp;
    s/#.*$//;
    s/^\s+//;
    s/\s+$//;
    next if /^$/;
    my($DN, $user) = /^\s*("[^"]*")\s*(\S+)\s*$/;
    if (not defined $DN or not defined $user) {
        print "# >>> Can't parse line $.: $_\n";
    }
    else {
        print "\$gxmap -add -force -dn $DN -username $user -no-email ",
              "-comment 'Mapping generated by $Program_Name'\n";
    }
}
