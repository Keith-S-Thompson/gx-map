# $Id: bug-0064,v 1.9 2007-01-11 18:50:24-08 kst Exp $
# $Source: /home/kst/gx-map-redacted/bugs/bug-0064,v $

gx-map bug 0064
Date: Fri 2006-01-20
Severity: High
Reported by: Keith Thompson <kst@sdsc.edu>
Version: 0.5.0d0
Status: Open
Title: Feature: Require user to prove he owns a certificate

Summary:
Currently, the gx-map system allows a user to map any arbitrary DN to
his own Unix account name.  This isn't necessarily a security hole
as long as a user can't map his own DN to someone else's account,
but it could cause some problems.  For one, a user could map someone
else's DN to his own account; this could deny the victim access
to his own account (while simultaneously giving the victim access
to the attacker's account, so it's not a very effective attack).
For another, it could create security problems for any software that
treats the grid-mapfile as a mapping from user names to DNs, rather
than just DNs to user names (which *shouldn't* be done).  Finally,
it introduces the possibility of typos.

Consider requiring the user running gx-request to prove that he
owns, or at least can use, the certificate with the requested DN.
For example, require the user to specify a certificate file (or use
the default $HOME/.globus/usercert.pem) and prompt for its passphrase.

Make it an install-time configuration option.

Since gx-request is not privileged, validation is non-trivial.
Presumably, once the user enters a passphrase, gx-request could use the
user's certificate to cryptographically sign a file, storing the signed
file along with a copy of the certificate (*not* the private key)
in the request file.  gx-check-requests could then confirm that the
file in the request was actually signed by the certificate, and that
the certificate was signed by a recognized CA (so the system on which
gx-check-requests runs has to have its /etc/grid-security/certificates
directory set up properly).

A gx-map administrator could still request mappings without
confirming the certificate, as is done currently.  I might also
consider requiring an administrator to sign any requests, using a
configured DN.  For automated use, the certificate would have to have
no passphrase, and the private key would have to be carefully guarded;
perhaps this could be restricted to a secure server.  Possibly this
could be another install-time configuration option.

Obviously this requires more thought and work.

More thoughts:

I think the way to do this is to have the user sign the request
file itself.  I had been thinking of signing a copy of /dev/null
(we'd care about the signature, not the contents), but a link to an
external signed file is too dangerous; someone might forge a request
file that points to somebody else's signed file.

To sign a file, including a copy of the user certificate in the
signed file:

    openssl smime -sign \
                  -text \
                  -in FILE \
                  -out FILE.signed \
                  -signer $HOME/.globus/usercert.pem \
                  -inkey $HOME/.globus/userkey.pem

This will prompt for the user's passphrase.

Note that this is intended for e-mail, and seems to assume that
the input file is text (fortunately, a request file is plain text).
It adds '\r' characters, so we haved to make sure we allow for that.

To verify a signature:

    openssl smime -verify \
                  -text \
                  -in FILE.signed \
		  -out FILE.recovered \
                  -CApath /etc/grid-security/certificates

To extract the signer's DN (this does *not* verify the signature):

    openssl smime -pk7out -in motd.signed | \
    openssl pkcs7 -print_certs -noout

So gx-request will have to deal with both signed and unsigned request
files.  Use a naming convention to distinguish between them, and (if
configured) don't accept unsigned requests from non-administrators.
For unsigned requests, everything works as it does not.  For signed
requests, the signed request itself is moved to the good-requests
(or bad-requests) directory, but only information from the contained
request is appended to requests.log -- along with a new attribute
indicating that the signature was verified.

This could be broken if someone is able to introduce a hacked copy
of openssl, which makes it very important for the specified PATH to
be secure.  Emphasize this in the documentation, and in sample.conf.
(gx-map currently uses openssl, but not in any security-critical
manner.)

Another thought:

A user should *not* be required to prove he owns the certificate for a
"remove" or "remove-user" request.  (A "remove-dn" request requires
administrative privileges.)  If somebody has somehow managed to map
his own DN to my account, I should be able to remove that mapping
(obviously I can't prove I own the certificate in that case).

Sun 2006-11-05
Raised priority to High; planning to add this in the next release
after 0.5.3.

Yet another thought:

How do we handle requests made before this feature was implemented?
Probably make it yet another configuration option (or perhaps a value
"STRICT" for a single option?).  Each new request has a new attribute,
indicating whether it's been signed and verified.  In strict mode,
any unsigned user "add" request will be rejected.  In a looser mode,
records for which this attribute is missing (i.e., old requests from
before signing was implemented) are accepted.

Thu 2007-01-11
In the summary above, I wrote that mapping someone else's DN to
your own account isn't a very effective attack.  In fact, it can be.
In the following scenario, I'm the attacker and you're the victim.

Suppose I map your DN to my account on some resource.  You try to
login to the resource using gsi-ssh, and you're logged in under
my account.  In my .profile or other init script, I grab a copy of
your delegated proxy, which I can then use to access your account.
I also print a bogus error message and log out, making you think you
were simply unable to login to the system.  There will be a record of
the mapping in the gx-map requests.log file, but that might not be
detected in time -- and it's possible that the attacker is not me,
but someone else who has previously broken into my account (by this
or some other technique).  So allowing users to map arbitrary DNs
to their own accounts could be a serious security hole.  (It can
be alleviated somewhat if gsi-ssh users habitually use "user@site"
rather than just "site".)

Abe Singer has pointed out a problem with the approach of having
gx-request sign the request file using the user's certificate.
It requires the user{cert,key}.pem files to be available on the system
where the user runs gx-request; it also requires the user to type
his passphrase on that system.  This can defeat the purpose of proxy
delegation; the user should be able to store his user{cert,key}.pem
on a single system (possibly one with no gx-map installation) and
use proxies for access to any other systems.  Requiring the user to
copy his userkey.pem to a production system and enter the passphrase
there could be a security problem.  A number of users have their
user{cert,key}.pem files on production systems anyway, and at least
SDSC has gx-map installed on workstations, so this is still a useful
capability, but it shouldn't be the only option.

Another possibility is to use a proxy rather than a certificate and
key.  Proxies are routinely delegated from system to system anyway,
but using them presents some more problems.  For one thing, it's still
potentially inconvenient for users.  If I'm able to run grid-proxy-init
on the system, it's more convenient to use the proxy than to re-enter
the passphrase for the certificate.  But if I don't have copies of
my user{cert,key}.pem files on the system, then I can't delegated a
proxy to the system unless I already have an entry in the grid-mapfile.

The alternative is to run grid-proxy-init on my "home" system, then
manually copy the proxy file /tmp/x509up_uNNNN to the production
system, and give gx-request the name of the copy of the proxy.
You have to make sure that the permissions on the proxy are preserved
when you copy it (ssh does this by default, so it shouldn't be much
of a problem); if the proxy becomes group- or world-readable somehow,
gx-request can warn about it, but it could be too late by then.

Verifying a file signed with a proxy turns out to be complex.  A proxy
consists of three parts: the proxy certificate, the unencrypted
proxy private key, and a copy of the user certificate.  There are
(at least) four kinds of proxy certificates, distinguished by the
presence of "critical extension" fields.  An old-style "legacy"
proxy, generated by Globus 2.4.3 and earlier, has no extensions.
A pre-RFC proxy, generated by Globus 2.4.3 with the "-new" option or
by GT4 by default, has an extension field that is not recognized by
any version of OpenSSL.  An RFC proxy has an extension recognized by
OpenSSL starting with version 0.9.7g (Globus 4.0.1 includes OpenSSL
0.9.7d).  Finally, a proxy issued by a KCA (such as PSC or USC) has
several critical extension fields, some of which are not recognized
by OpenSSL, but it has no copy of the user certificate; instead,
the proxy certificate itself is signed by the CA.

The critical extension fields could present some problems.
In releases of OpenSSL prior to 0.9.7, these fields are quietly
ignored.  In release 0.9.8 and later, the presence of these fields
prevents a signature from being verified by default, but this can be
overridden by using "smime -verify -ignore_critical".  In the 0.9.7
series (0.9.7 and 0.9.7a through 0.9.7l), the critical fields in a
pre-RFC proxy prevent a signature from being verified, and there is
no "-ignore_critical" option.  (There is such an option to "openssl
verify", but that's used for verifying certificates, not signatures.)
(The critical extension in an RFC proxy is recognized starting in
OpenSSL 0.9.7g.)

Proposal:

Implement the new REQUIRE_SIGNATURES configuration option more or
less as already specified.  Allow verification using either a user
certificate and key *or* using a proxy; by default, look for a proxy,
then for a certificate.  Since in the current version of Globus
grid-proxy-init generates pre-RFC proxies by default, sites should be
strongly encouraged to install a version of OpenSSL that can handle
them (the latest is 0.9.8d).  (An older version of OpenSSL, 0.9.6m or
older, should also work, but that's not recommended.  Versions older
than 0.9.5 will not work, since they don't support "openssl smime".)
This needn't be installed as the default OpenSSL for the system;
it just needs to be in the specified PATH for gx-map.  If that's
not possible, then users may have to run "grid-proxy-init -old"
to generate an old-style proxy.
