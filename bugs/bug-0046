# $Id: bug-0046,v 1.1 2005-07-28 19:40:04-07 kst Exp $
# $Source: /home/kst/gx-map-redacted/bugs/bug-0046,v $

gx-map bug 0046
Date: Thu 2005-07-28
Severity: med
Reported by: Keith Thompson <kst@sdsc.edu>
Version: 0.4.5
Status: Open
Title: gx-request: Need finer-grained timestamps

Summary:
With the new model for multiple mappings, the script generated by
gx-ingest can includes gx-request calls that are order-dependent.
Specifically, if the input grid-mapfile contains

    "/O=Foo/OU=Bar/CN=John Smith" user1,user2

then the generated script will contain:

    $gx_request -add ... -username user2 -dn "/O=Foo/OU=Bar/CN=John Smith"
    $gx_request -add ... -username user1 -dn "/O=Foo/OU=Bar/CN=John Smith"

The order is significant because the last username will appear first in
the resulting grid-mapfile.  But since the current timestamps have only
one-second resolution, it's likely that both request files will have
the same timestamp, and they could then be processed in reverse order.
(In fact, it looks like they'll be processed in alphabetical order
by username, given the way the request file name is generated.)  This could
cause the generated grid-mapfile to contain:

    "/O=Foo/OU=Bar/CN=John Smith" user2,user1

Suggested fix:
Use Time::HiRes::time to determine the timestamp.
Include the fine-grained timestamp in the request file name using
the format "%17.6f" (since gx-check-requests determines the order by
sorting the request file names).

Note that this creates a dependency on the Time::HiRes Perl module.
