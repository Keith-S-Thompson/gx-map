# $Id: bug-0140,v 1.3 2007-03-20 18:29:33-07 kst Exp $
# $Source: /home/kst/gx-map-redacted/bugs/bug-0140,v $

gx-map bug 0140
Date: Wed 2007-03-14
Severity: High
Reported by: Keith Thompson <kst@sdsc.edu>
Version: 0.5.3.2.020
Status: Open
Title: Certificate is installed if CRL has expired

If a CRL has expired, gx-ca-update installs the CA certificate but
not the CRL.  Since Globus responsds to a missing CRL by accepting
all certificates, this creates a security hole.

This bug does not occur in the 0.5.3.2 release; in that release,
neither the CA certificate nor the CRL is installed.

I suspect this bug was introduced in gx-ca-update.in revision 1.136.

...

I've been unable to reproduce the exact bug I saw before.  A couple
of things I have found:

    If a certificate is newly installed and the CRL is then found
    to have expired, the temporary copy of the certificate is left
    in place.  This should be mostly harmless, but it's definitely
    a bug, caused by use of "delete" rather than "unlink" in
    Finalize_Certificate (actually it should do both).

    If a certificate already exists, and a CRL is found to have
    expired, the CRL is not installed but the certificate is left in
    place.  If an older version of the CRL already exists, that's ok.
    If there is no CRL, that's a problem.  We probably want to just
    go ahead and install expired CRLs.

...

Using gx-ca-update 0.5.3.2.022, and the CNRS-DataGrid CA (6b4ddd18)
(which currently happens to have an expired CRL):

Installing into an empty directory:
    Installs temporary certificate (6b4ddd18.0.4120).
    Downloads CRL, sees that it's expired.
    Deletes certificate (good!)

Installing into a directory that already has the certificate:
    Skips certificate
    Downloads CRL, sees that it's expired.
    Doesn't install CRL; leaves certificate in place.
    Bad; it should install the expired CRL, thereby disabling the CA.

Installing into a directory that already has the certificate *and*
an expired CRL:
    The existing certificate and CRL are left in place.
    That's probably ok; the CA remains disabled.

In general, if a CA requires a CRL, and I'm unable to download a
valid one for any of several reasons:
    The downloaded CRL has expired.
    The downloaded CRL is corrupted (signature test fails).
    The CRL cannot be downloaded.
then:
    if a CRL is already installed or cached:
        Use it.  (If it's expired, so be it.)
    else if the CA certificate is already installed:
        Install the expired CRL if possible.
        Otherwise, we still need to disable the CA;
        attempt to rename "xxxxxxxx.0" to "xxxxxxxx.0.bak"
    else
        Ok.
