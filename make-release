#!/bin/sh

# $Id: make-release,v 1.29 2006-11-21 15:00:56-08 kst Exp $
# $Source: /home/kst/gx-map-redacted/make-release,v $

try() {
    echo "% $@"
    eval "$@" || exit 1
}

today=`date +%Y-%m-%d`

if [ $# -eq 0 ] ; then
    num=`./get-version`
elif [ $# -eq 1 ] ; then
    case "$1" in
        [0-9]*)
            num=$1
            ;;
        *)
            echo "Usage: $0 [num]" 1>&2
            exit 1
            ;;
    esac
else
    echo "Usage: $0 [num]" 1>&2
    exit 1
fi

if [ "$num" = "" ] ; then
    echo "Error getting version" 1>&2
    echo "Usage: $0 [num]" 1>&2
    exit 1
fi

if [ -f release/gx-map-$num.tar.gz ] ; then
    echo "release/gx-map-$num.tar.gz already exists" 1>&2
    exit 1
fi

cadesc_tarball=gx-map-cadesc-$today.tar.gz
if [ -f $cadesc_tarball ] ; then
    echo ">>> Using existing $cadesc_tarball"
else
    try ./make-cadesc-release
fi

in_files=`ls *.in | grep -v gx-map.conf.in`
other_files="INSTALL LICENSE Makefile README README.TeraGrid \
             README.Upgrade Relnotes auto.txt cleanup-gx-map \
             configure-gx-map gettimeofday.c gx-check-prereqs \
             gx-propagate.in.teragrid gx-propagate.in.test \
             sample-gx-cron-job.conf sample.conf test-gx-map \
             tgcdb.db-config"

try mkdir release/gx-map-$num
try cd release/gx-map-$num

for file in $in_files ; do
    try cp -p ../../$file .
done
for file in $other_files ; do
    try cp -p ../../$file .
done

try cp -p ../$cadesc_tarball .

try mkdir bugs
try cd bugs
ls ../../../bugs | grep '^bug-....$' | \
    while read file ; do
        try cp -p ../../../bugs/$file .
    done
try cd ..

try mkdir doc
try cd doc
ls ../../../doc | grep '\.pod$' | \
    while read file ; do
        try cp -p ../../../doc/$file .
    done
try cd ..

try cd ..
try tar zcf gx-map-$num.tar.gz gx-map-$num
try rm -rf gx-map-$num
