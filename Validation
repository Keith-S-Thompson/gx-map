# $Id: Validation,v 1.3 2005-11-18 16:43:21-08 kst Exp $
# $Source: /home/kst/gx-map-redacted/Validation,v $

Validating a request

Each request must be validated before being applied to a grid-mapfile.
The gx-request client command is designed to create only valid request
files, but since it's unprivileged a user could easily create
a phony request file with whatever contents he wants.

There are (among others) three pairs of attributes in a request,
each of which represents a Unix user name and a numeric UID.
There are the focus of the validation requirements.

    username, user_uid
	These represent the account to which the mapping applies.
	There are not set for a remove-dn request.  For other requests,
	the username will always be set; the user_uid may or may not
	be set.  (It won't be set if an administrator runs gx-request
	on a user's behalf on a machine where the user doesn't have
	an account.)

    requested_by_name, requested_by_uid
	These are implicitly set by gx-request.  They represent the
	user who ran the gx-request command.  Both are always set.

    OWNER_NAME, OWNER_UID
	These are set by gx-check-requests in the request annotated
	to the requests.log file; they don't appear in the original
	request file generated by gx-request.  They correspond to the
	actual owner of the request file, as determined by stat().
	The OWNER_UID is always set; the OWNER_NAME may not be set if
	the corresponding user doesn't have an account on the machine
	where gx-check-requests is executed.

There are three points at which checking must be performed.

0.  The gx-request client command is designed to create only
    valid request files; it checks that the command-line options or
    interactively entered information are consistent and allowed, but
    since the gx-request command is unprivileged a user could easily
    create a phony request file with whatever contents he wants.
    Any checks done here are as a matter of convenience.

1.  In gx-check-requests, we need to check the validity of the
    request before appending it to the requests.log file, *and*
    before (optionally) attempting to invoke gx-propagate.  If any
    of these checks fail, the record is moved to the bad-requests
    directory and appended, with annotations, to errors.log (both
    of which are then ignored unless someone wants to examine them.
    If all the checks are successful, the request is moved to the
    good-requests directory and appended, with annotations, to the
    requests.log file, where it can be used by gx-gen-mapfile.

    The checks are:

    File format is correct (i.e., Read_Records doesn't choke)

    All required fields exist.

    No unrecognized fields exist.

    No key other than "comment" occurs more than once.

    operation is valid (one of add, remove, remove-user, remove-dn)

    if operation is remove-dn
	username is not defined
    else
	username is defined

    if operation is remove-user
	dn is not defined
    else
	dn is defined

    dn (if defined) starts and ends with a '"' character, and has no
    other '"' characters.

    timestamp is no more than 60 seconds in the future (allow for
    clock skew) (we allow arbitrarily old requests)

    username matches user_uid (if the account exists)

    requested_by_name matches requested_by_uid (if the account exists)

    OWNER_UID matches requested_by_uid

    if OWNER_UID is not an administrator
	operation is not remove-dn
	user_uid, if set, matches OWNER_UID
	source is not set

========================================================================

2.  Some additional checks will cause gx-request *not* to attempt to
    invoke gx-propagate, but will not prevent the request from being
    appended to requests.log.  In this case, the PROPAGATION attribute
    is set to "failed" (possibly with an explanation), and an e-mail
    notice will be sent.  Note that a request for a user who doesn't
    have an account on the system where gx-check-requests is run
    (chester at SDSC) may not be propagated properly.

    username has an account on the system.

    requested_by_name has an account on the system.

3.  Once a request is appended to the requests.log file, it's assumed
    to be valid, but gx-gen-mapfile will still do some additional
    checks (some of them possibly redundant) before accepting the
    request.

    if operation is not remove-dn
	username is set
	if "-all" is not specified
	    username has an account on the system
